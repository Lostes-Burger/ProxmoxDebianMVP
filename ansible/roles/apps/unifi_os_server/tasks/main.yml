---
- name: Install UniFi OS Server prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
    state: present
    update_cache: true

- name: Fetch UniFi OS Server releases page
  ansible.builtin.command:
    cmd: curl -fsSL https://www.ui.com/download/releases/unifi-os-server
  register: uos_release_page
  changed_when: false

- name: Normalize UniFi OS Server releases page content
  ansible.builtin.set_fact:
    uos_release_page_normalized: >-
      {{
        uos_release_page.stdout
        | regex_replace('\\\\/', '/')
        | regex_replace('\\\\u002[Ff]', '/')
        | regex_replace('\\\\u0026', '&')
      }}

- name: Extract UniFi OS Server metadata URL candidates
  ansible.builtin.set_fact:
    uos_metadata_url_candidates: >-
      {{
        (
          uos_release_page_normalized
          | regex_findall('https://[^\"''\\s<>]*(?:\\.json|\\.js)(?:\\?[^\"''\\s<>]*)?')
        )
        +
        (
          uos_release_page_normalized
          | regex_findall('/(?:_next|_nuxt|assets|download|releases)[^\"''\\s<>]*(?:\\.json|\\.js)(?:\\?[^\"''\\s<>]*)?')
          | map('regex_replace', '^(.*)$', 'https://www.ui.com\\1')
          | list
        )
      | unique
      }}

- name: Fetch UniFi OS Server metadata pages
  ansible.builtin.command:
    cmd: "curl -fsSL {{ item | quote }}"
  loop: "{{ uos_metadata_url_candidates[:30] }}"
  register: uos_metadata_pages
  changed_when: false
  failed_when: false

- name: Combine UniFi OS Server release and metadata content
  ansible.builtin.set_fact:
    uos_release_content_combined: >-
      {{
        (
          [uos_release_page_normalized]
          +
          (
            (uos_metadata_pages.results | default([]))
            | selectattr('rc', 'equalto', 0)
            | map(attribute='stdout')
            | list
          )
        )
        | join('\n')
      }}

- name: Define UniFi OS Server fallback source URLs
  ansible.builtin.set_fact:
    uos_fallback_source_urls:
      - "https://fw-download.ubnt.com/data/unifi-os-server/"
      - "https://dl.ui.com/"
      - "https://www.ui.com/download/releases/unifi-os-server"
      - "https://www.ui.com/downloads/unifi-os-server"
      - "https://www.ui.com/downloads"

- name: Fetch UniFi OS Server fallback sources
  ansible.builtin.command:
    cmd: "curl -fsSL {{ item | quote }}"
  loop: "{{ uos_fallback_source_urls }}"
  register: uos_fallback_sources
  changed_when: false
  failed_when: false

- name: Append fallback source content
  ansible.builtin.set_fact:
    uos_release_content_combined: >-
      {{
        (
          [uos_release_content_combined]
          +
          (
            (uos_fallback_sources.results | default([]))
            | selectattr('rc', 'equalto', 0)
            | map(attribute='stdout')
            | list
          )
        )
        | join('\n')
      }}

- name: Extract UniFi OS Server deb URL candidates
  ansible.builtin.set_fact:
    uos_download_candidates: >-
      {{
        (
          uos_release_content_combined
          | regex_findall('https://[^\"''\\s<>]*\\.deb(?:\\?[^\"''\\s<>]*)?')
        )
        +
        (
          uos_release_content_combined
          | regex_findall('https:\\\\/\\\\/[^\"''\\s<>]*\\.deb(?:\\?[^\"''\\s<>]*)?')
          | map('regex_replace', '^https:\\\\/\\\\/', 'https://')
          | map('regex_replace', '\\\\/', '/')
          | list
        )
        +
        (
          uos_release_content_combined
          | regex_findall('//fw-download\\.ubnt\\.com/[^\"''\\s<>]*\\.deb')
          | map('regex_replace', '^(.*)$', 'https:\\1')
          | list
        )
        +
        (
          uos_release_content_combined
          | regex_findall('fw-download\\.ubnt\\.com/data/unifi-os-server/[^\"''\\s<>]*\\.deb')
          | map('regex_replace', '^(.*)$', 'https://\\1')
          | list
        )
      | unique
      }}

- name: Pick preferred UniFi OS Server download URL
  ansible.builtin.set_fact:
    uos_download_url: >-
      {{
        (
          (
            uos_download_candidates
            | select('search', '(?i)(unifi[-_.]?os[-_.]?server|uosserver).*(linux-x64|linux-amd64|amd64|x64)|(linux-x64|linux-amd64|amd64|x64).*(unifi[-_.]?os[-_.]?server|uosserver)')
            | list
            | first
          )
          | default(
              (
                uos_download_candidates
                | select('search', '(?i)(unifi[-_.]?os[-_.]?server|uosserver)')
                | list
                | first
              ),
              true
            )
          | default(
              (
                uos_download_candidates
                | select('search', '(?i)unifi.*(linux-x64|linux-amd64|amd64|x64)|(linux-x64|linux-amd64|amd64|x64).*unifi')
                | list
                | first
              ),
              true
            )
          | default(
              (
                uos_download_candidates
                | select('search', '(?i)linux-x64|linux-amd64|amd64|x64')
                | list
                | first
              ),
              true
            )
          | default(
              (
                uos_download_candidates
                | first
              ),
              true
            )
        )
        | default('', true)
      }}

- name: Override UniFi OS Server download URL when provided
  ansible.builtin.set_fact:
    uos_download_url: "{{ uos_download_url_override | trim }}"
  when:
    - uos_download_url_override is defined
    - (uos_download_url_override | trim | length) > 0

- name: Ensure UniFi OS Server URL was found
  ansible.builtin.assert:
    that:
      - uos_download_url | length > 0
    fail_msg: >-
      Konnte keine UniFi OS Server Linux-x64 .deb URL auf ui.com finden.
      Gepruefte Metadata-URLs: {{ uos_metadata_url_candidates | length }}.
      Gefundene .deb-Kandidaten: {{ uos_download_candidates | length }}.
      Optional: setze uos_download_url_override auf eine direkte .deb URL.

- name: Set local paths for UniFi OS Server package
  ansible.builtin.set_fact:
    uos_deb_path: "/tmp/{{ uos_download_url | basename }}"
    uos_marker_path: "/var/lib/unifi-os-server/.orchestrator_last_url"

- name: Ensure marker directory exists
  ansible.builtin.file:
    path: "/var/lib/unifi-os-server"
    state: directory
    mode: "0755"

- name: Check currently installed UniFi OS Server URL marker
  ansible.builtin.stat:
    path: "{{ uos_marker_path }}"
  register: uos_marker_stat

- name: Read UniFi OS Server URL marker
  ansible.builtin.slurp:
    path: "{{ uos_marker_path }}"
  when: uos_marker_stat.stat.exists
  register: uos_marker_content

- name: Set currently installed UniFi OS Server URL
  ansible.builtin.set_fact:
    uos_current_url: "{{ (uos_marker_content.content | b64decode | trim) if uos_marker_stat.stat.exists else '' }}"

- name: Download latest UniFi OS Server package
  ansible.builtin.command:
    cmd: "curl -fL {{ uos_download_url }} -o {{ uos_deb_path }}"
  when: uos_current_url != uos_download_url

- name: Install UniFi OS Server package
  ansible.builtin.apt:
    deb: "{{ uos_deb_path }}"
    state: present
  when: uos_current_url != uos_download_url

- name: Update UniFi OS Server URL marker
  ansible.builtin.copy:
    content: "{{ uos_download_url }}\n"
    dest: "{{ uos_marker_path }}"
    mode: "0644"
  when: uos_current_url != uos_download_url

- name: Ensure UniFi OS Server service is running (if present)
  ansible.builtin.systemd:
    name: uosserver
    enabled: true
    state: started
  failed_when: false
