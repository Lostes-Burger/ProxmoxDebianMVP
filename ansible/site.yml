---
- name: Provision Debian VM
  hosts: targets
  become: true

  tasks:
    - name: Show selected modules
      ansible.builtin.debug:
        msg: "Ausgewählte Module: {{ modules_selected | default([]) | join(', ') if (modules_selected | default([]) | length > 0) else 'keine' }}"

    - name: Validate selected modules
      ansible.builtin.assert:
        that:
          - item in ['baseline_tools', 'unattended_upgrades', 'network_ifupdown', 'ufw', 'fail2ban', 'sysctl_hardening']
        fail_msg: "Unbekanntes Modul ausgewählt: {{ item }}"
      loop: "{{ modules_selected | default([]) }}"

    - name: Validate selected apps
      ansible.builtin.assert:
        that:
          - item in ['docker', 'nginx', 'unifi_os_server']
        fail_msg: "Unbekannte App ausgewählt: {{ item }}"
      loop: "{{ apps_selected | default([]) }}"

    - name: Show selected apps
      ansible.builtin.debug:
        msg: "Ausgewählte Apps: {{ apps_selected | default([]) | join(', ') if (apps_selected | default([]) | length > 0) else 'keine' }}"

    - name: Install unattended-upgrades packages when selected
      ansible.builtin.apt:
        name:
          - unattended-upgrades
          - apt-listchanges
        state: present
        update_cache: true
      when: "'unattended_upgrades' in (modules_selected | default([]))"

    - name: Configure apt periodic auto updates when selected
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: "0644"
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";
      when: "'unattended_upgrades' in (modules_selected | default([]))"

    - name: Configure unattended-upgrades defaults when selected
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/52unattended-upgrades-custom
        owner: root
        group: root
        mode: "0644"
        content: |
          Unattended-Upgrade::Automatic-Reboot "false";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
      when: "'unattended_upgrades' in (modules_selected | default([]))"

    - name: Enable unattended-upgrades service when selected
      ansible.builtin.service:
        name: unattended-upgrades
        state: started
        enabled: true
      when: "'unattended_upgrades' in (modules_selected | default([]))"

    - name: Check existing sysctl hardening config
      ansible.builtin.stat:
        path: /etc/sysctl.d/99-orchestrator-hardening.conf
      register: sysctl_hardening_conf_stat
      when: "'sysctl_hardening' in (modules_selected | default([]))"

    - name: Backup existing sysctl hardening config once
      ansible.builtin.copy:
        src: /etc/sysctl.d/99-orchestrator-hardening.conf
        dest: /etc/sysctl.d/99-orchestrator-hardening.conf.bak
        remote_src: true
        owner: root
        group: root
        mode: "0644"
        force: false
      when:
        - "'sysctl_hardening' in (modules_selected | default([]))"
        - sysctl_hardening_conf_stat.stat.exists

    - name: Write conservative sysctl hardening profile
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-orchestrator-hardening.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          # Managed by Proxmox Debian VM Orchestrator
          net.ipv4.conf.all.accept_redirects=0
          net.ipv4.conf.default.accept_redirects=0
          net.ipv4.conf.all.secure_redirects=0
          net.ipv4.conf.default.secure_redirects=0
          net.ipv4.conf.all.send_redirects=0
          net.ipv4.conf.default.send_redirects=0
          net.ipv4.conf.all.accept_source_route=0
          net.ipv4.conf.default.accept_source_route=0
          net.ipv4.icmp_echo_ignore_broadcasts=1
          net.ipv4.icmp_ignore_bogus_error_responses=1
          net.ipv4.tcp_syncookies=1
          net.ipv4.conf.all.rp_filter=1
          net.ipv4.conf.default.rp_filter=1
          net.ipv6.conf.all.accept_redirects=0
          net.ipv6.conf.default.accept_redirects=0
          kernel.kptr_restrict=2
          kernel.dmesg_restrict=1
          fs.protected_hardlinks=1
          fs.protected_symlinks=1
      register: sysctl_hardening_conf
      when: "'sysctl_hardening' in (modules_selected | default([]))"

    - name: Apply sysctl hardening profile
      ansible.builtin.command:
        cmd: sysctl --system
      when:
        - "'sysctl_hardening' in (modules_selected | default([]))"
        - sysctl_hardening_conf.changed

    - name: Ensure static network values are present for ifupdown module
      ansible.builtin.assert:
        that:
          - (vm_ip_cidr | default('') | length) > 0
          - (vm_gateway | default('') | length) > 0
        fail_msg: "Für static IP werden vm_ip_cidr und vm_gateway benötigt."
      when:
        - "'network_ifupdown' in (modules_selected | default([]))"
        - (vm_ip_mode | default('dhcp')) == 'static'

    - name: Determine primary interface for ifupdown module
      ansible.builtin.set_fact:
        ifupdown_primary_iface: "{{ ansible_default_ipv4.interface }}"
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Ensure ifupdown package is installed when selected
      ansible.builtin.apt:
        name: ifupdown
        state: present
        update_cache: true
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Check current /etc/network/interfaces
      ansible.builtin.stat:
        path: /etc/network/interfaces
      register: interfaces_file_stat
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Backup current /etc/network/interfaces once
      ansible.builtin.copy:
        src: /etc/network/interfaces
        dest: /etc/network/interfaces.before-ifupdown.bak
        remote_src: true
        owner: root
        group: root
        mode: "0644"
        force: false
      when:
        - "'network_ifupdown' in (modules_selected | default([]))"
        - interfaces_file_stat.stat.exists

    - name: Disable cloud-init network rendering for future boots
      ansible.builtin.copy:
        dest: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
        owner: root
        group: root
        mode: "0644"
        content: |
          network: {config: disabled}
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Write classic ifupdown network config
      ansible.builtin.copy:
        dest: /etc/network/interfaces
        owner: root
        group: root
        mode: "0644"
        content: |
          source /etc/network/interfaces.d/*
          auto lo
          iface lo inet loopback

          auto {{ ifupdown_primary_iface }}
          iface {{ ifupdown_primary_iface }} inet {% if (vm_ip_mode | default('dhcp')) == 'static' %}static{% else %}dhcp{% endif %}
          {% if (vm_ip_mode | default('dhcp')) == 'static' %}
              address {{ vm_ip_cidr }}
              gateway {{ vm_gateway }}
          {% endif %}
          {% if (vm_dns_server | default('') | length) > 0 %}
              dns-nameservers {{ vm_dns_server }}
          {% endif %}
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Gather service facts for network service adjustments
      ansible.builtin.service_facts:
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Disable systemd-networkd when present
      ansible.builtin.service:
        name: systemd-networkd
        enabled: false
        state: stopped
      when:
        - "'network_ifupdown' in (modules_selected | default([]))"
        - "'systemd-networkd.service' in ansible_facts.services"

    - name: Enable networking service when present
      ansible.builtin.service:
        name: networking
        enabled: true
      when:
        - "'network_ifupdown' in (modules_selected | default([]))"
        - "'networking.service' in ansible_facts.services"

    - name: Build app port list for optional UFW opening
      ansible.builtin.set_fact:
        app_ports_to_open: >-
          {{
            (
              [{'port': '80', 'proto': 'tcp'}, {'port': '443', 'proto': 'tcp'}]
              if ('nginx' in (apps_selected | default([]))) else []
            )
            +
            (
              [
                {'port': '11443', 'proto': 'tcp'},
                {'port': '5005', 'proto': 'tcp'},
                {'port': '9543', 'proto': 'tcp'},
                {'port': '6789', 'proto': 'tcp'},
                {'port': '8080', 'proto': 'tcp'},
                {'port': '8443', 'proto': 'tcp'},
                {'port': '8444', 'proto': 'tcp'},
                {'port': '5671', 'proto': 'tcp'},
                {'port': '8880', 'proto': 'tcp'},
                {'port': '8881', 'proto': 'tcp'},
                {'port': '8882', 'proto': 'tcp'},
                {'port': '3478', 'proto': 'udp'},
                {'port': '5514', 'proto': 'udp'},
                {'port': '10003', 'proto': 'udp'}
              ]
              if ('unifi_os_server' in (apps_selected | default([]))) else []
            )
          }}

    - name: Install UFW when selected
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: true
      when: "'ufw' in (modules_selected | default([]))"

    - name: Set UFW defaults when selected
      ansible.builtin.command:
        cmd: "{{ item }}"
      loop:
        - "ufw default deny incoming"
        - "ufw default allow outgoing"
      when: "'ufw' in (modules_selected | default([]))"

    - name: Allow SSH through UFW when selected
      ansible.builtin.command:
        cmd: "ufw allow {{ ansible_port | default(22) }}/tcp"
      when: "'ufw' in (modules_selected | default([]))"

    - name: Allow selected app ports through UFW
      ansible.builtin.command:
        cmd: "ufw allow {{ item.port }}/{{ item.proto }}"
      loop: "{{ app_ports_to_open | default([]) }}"
      when:
        - "'ufw' in (modules_selected | default([]))"
        - ufw_open_app_ports | default(false) | bool
        - (app_ports_to_open | default([]) | length) > 0

    - name: Enable UFW when selected
      ansible.builtin.command:
        cmd: "ufw --force enable"
      when: "'ufw' in (modules_selected | default([]))"

    - name: Reboot after network backend switch
      ansible.builtin.reboot:
        msg: "Reboot after network backend migration to ifupdown"
        connect_timeout: 10
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 5
      when: "'network_ifupdown' in (modules_selected | default([]))"

    - name: Run selected app roles
      ansible.builtin.include_role:
        name: "apps/{{ item }}"
      loop: "{{ apps_selected | default([]) }}"
